# ç›‘æ§è§†é¢‘äººå½¢æ£€æµ‹å·¥å…·

> ğŸ¯ **é‡Šæ”¾å­˜å‚¨ç©ºé—´** - å­˜å‚¨ä»·æ ¼æš´æ¶¨ï¼Œç©ºé—´å¯¸åœŸå¯¸é‡‘  
> ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ **ä¿ç•™æœ‰æ„ä¹‰çš„ç‰‡æ®µ** - åªç•™ä¸‹æœ‰å®¶äººã€æœ‰äººç‰©çš„çè´µç”»é¢  
> âœ‚ï¸ **æ™ºèƒ½å‹ç¼©** - è£å‰ªé™æ­¢ç”»é¢ï¼Œåˆå¹¶ç¢ç‰‡æ–‡ä»¶ï¼Œå¤§å¹…å‡å°‘æ–‡ä»¶æ•°é‡  
> ğŸ”’ **æœ¬åœ° AI å¤„ç†** - æ•°æ®ä¸å‡ºæœ¬æœºï¼Œéšç§å®‰å…¨æ— å¿§

è‡ªåŠ¨æ£€æµ‹ç›‘æ§è§†é¢‘ä¸­çš„äººç‰©ï¼Œæå–æœ‰äººçš„ç‰‡æ®µå¹¶åˆå¹¶è¾“å‡ºã€‚ä½¿ç”¨ YOLOv8 æœ¬åœ°è§†è§‰æ¨¡å‹ + FFmpeg å¤šçº¿ç¨‹è§£ç ï¼Œé«˜æ•ˆåˆ©ç”¨å¤šæ ¸ CPUã€‚

[English](README.md) | [ä¸­æ–‡](README_CN.md)

---

### åŠŸèƒ½ç‰¹ç‚¹

- **äººç‰©æ£€æµ‹**ï¼šä½¿ç”¨ YOLOv8 æ£€æµ‹ç›‘æ§è§†é¢‘ä¸­çš„äººç‰©
- **æ™ºèƒ½è£å‰ª**ï¼šä½¿ç”¨ FFmpeg ä»…æå–åŒ…å«äººç‰©çš„è§†é¢‘ç‰‡æ®µ
- **è‡ªåŠ¨åˆå¹¶**ï¼šè‡ªåŠ¨åˆå¹¶è¿ç»­çš„è§†é¢‘ç‰‡æ®µ
- **å¢é‡å¤„ç†**ï¼šä½¿ç”¨ JSONL æ—¥å¿—è‡ªåŠ¨è·³è¿‡å·²å¤„ç†çš„æ–‡ä»¶
- **æ™ºèƒ½åˆ†ç»„**ï¼šæ ¹æ®åˆ›å»ºæ—¶é—´è‡ªåŠ¨è¯†åˆ«å¹¶åˆ†ç»„è¿ç»­çš„ç›‘æ§è§†é¢‘
- **å¤šå“ç‰Œæ”¯æŒ**ï¼šå¯æ‰©å±•çš„æ—¶é—´æˆ³è§£æå™¨ï¼Œæ”¯æŒä¸åŒå“ç‰Œç›‘æ§ï¼ˆå°ç±³ã€æµ·åº·å¨è§†ã€å¤§åç­‰ï¼‰
- **é«˜æ€§èƒ½æ¶æ„**ï¼šI/O Worker ä¸ Detector Worker åˆ†ç¦»ï¼ŒFFmpeg å¤šçº¿ç¨‹è§£ç 
- **è‡ªåŠ¨é…ç½®**ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®æœ€ä½³å‚æ•°
- **è·¨å¹³å°**ï¼šæ”¯æŒ Windowsã€macOS å’Œ Linux

### æ”¯æŒçš„ç›‘æ§å“ç‰Œ

| å“ç‰Œ | è§£æå™¨ | æ–‡ä»¶å‘½åè§„åˆ™ |
|------|--------|-------------|
| **å°ç±³** | `xiaomi` | æ–‡ä»¶å¤¹: `YYYYMMDDHH` + æ–‡ä»¶å: `MMmSSs_TIMESTAMP.mp4` |
| **æµ·åº·å¨è§†** | `hikvision` | `YYYYMMDDHHMMSS.mp4` æˆ– `ch01_YYYYMMDDHHMMSS.mp4` |
| **å¤§å** | `dahua` | `YYYY-MM-DD HH-MM-SS.mp4` æˆ– `YYYYMMDD_HHMMSS.mp4` |
| **é€šç”¨** | `generic` | è‡ªåŠ¨æ£€æµ‹å¤šç§å¸¸è§æ—¶é—´æ ¼å¼ |
| **è‡ªåŠ¨** | `auto` | ä¾æ¬¡å°è¯•æ‰€æœ‰è§£æå™¨ |

### ç³»ç»Ÿè¦æ±‚

- Python 3.10+
- FFmpegï¼ˆç”¨äºè§†é¢‘å¤„ç†å’Œè§£ç ï¼‰
- GPUï¼ˆå¯é€‰ï¼Œç”¨äºåŠ é€Ÿæ£€æµ‹ï¼‰

### å®‰è£…

1. **å…‹éš†ä»“åº“**
   ```bash
   git clone https://github.com/yourusername/surveillance-video-human-detector.git
   cd surveillance-video-human-detector
   ```

2. **ä½¿ç”¨ uv å®‰è£…ä¾èµ–**
   ```bash
   # å®‰è£… uvï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
   curl -LsSf https://astral.sh/uv/install.sh | sh

   # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒå¹¶å®‰è£…ä¾èµ–
   uv sync
   ```

3. **å®‰è£… FFmpeg**
   ```bash
   # macOS
   brew install ffmpeg

   # Ubuntu/Debian
   sudo apt install ffmpeg

   # Windowsï¼ˆä½¿ç”¨ Chocolateyï¼‰
   choco install ffmpeg
   ```

### ä½¿ç”¨æ–¹æ³•

#### å¿«é€Ÿå¼€å§‹

```bash
# åŸºæœ¬ç”¨æ³•ï¼ˆé»˜è®¤å°ç±³ç›‘æ§ï¼Œè‡ªåŠ¨é…ç½®å‚æ•°ï¼‰
uv run python pipeline.py ./test-videos

# æŒ‡å®šç›‘æ§å“ç‰Œ
uv run python pipeline.py ./videos --brand hikvision
uv run python pipeline.py ./videos --brand dahua
uv run python pipeline.py ./videos --brand auto  # è‡ªåŠ¨æ£€æµ‹

# æŒ‡å®šè¾“å‡ºç›®å½•
uv run python pipeline.py ./videos -o ./output

# ä½¿ç”¨æ›´ç²¾ç¡®çš„æ¨¡å‹
uv run python pipeline.py ./videos --model yolov8s.pt
```

**å‚æ•°è¯´æ˜ï¼š**
| å‚æ•° | ç®€å†™ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `input` | | (å¿…å¡«) | è¾“å…¥è§†é¢‘ç›®å½•è·¯å¾„ |
| `--output` | `-o` | `results` | è¾“å‡ºç»“æœç›®å½•è·¯å¾„ |
| `--brand` | `-b` | `xiaomi` | ç›‘æ§å“ç‰Œï¼ˆxiaomi/hikvision/dahua/generic/autoï¼‰ |
| `--threshold` | `-t` | `300` | è¿ç»­æ€§åˆ¤æ–­æ—¶é—´é˜ˆå€¼ï¼ˆç§’ï¼Œé»˜è®¤ 5 åˆ†é’Ÿï¼‰ |
| `--workers` | `-w` | è‡ªåŠ¨ | I/O Worker è¿›ç¨‹æ•°é‡ï¼ˆæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®ï¼‰ |
| `--detectors` | `-d` | è‡ªåŠ¨ | Detector Worker è¿›ç¨‹æ•°é‡ï¼ˆæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®ï¼‰ |
| `--batch-size` | | è‡ªåŠ¨ | æ£€æµ‹æ‰¹å¤§å°ï¼ˆæ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®ï¼‰ |
| `--model` | `-m` | `yolov8n.pt` | YOLO æ¨¡å‹åç§° |
| `--confidence` | `-c` | `0.5` | æ£€æµ‹ç½®ä¿¡åº¦é˜ˆå€¼ |
| `--interval` | | `3.0` | é‡‡æ ·é—´éš”ï¼ˆç§’ï¼‰ |
| `--scan-workers` | | `8` | æ–‡ä»¶æ‰«æå¹¶è¡Œçº¿ç¨‹æ•° |

#### è‡ªåŠ¨é…ç½®

Pipeline æ ¹æ® CPU æ ¸å¿ƒæ•°è‡ªåŠ¨é…ç½®å‚æ•°ï¼š

| CPU æ ¸å¿ƒæ•° | I/O Workers | Detectors | Batch Size |
|------------|-------------|-----------|------------|
| 1-2 æ ¸     | 2           | 1         | 16         |
| 3-4 æ ¸     | 4           | 2         | 32         |
| 5-8 æ ¸     | 10          | 6         | 48         |
| 9-16 æ ¸    | 16          | 10        | 64         |
| 17+ æ ¸     | 20          | 14        | 64         |

#### Pipeline æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Producer (ä¸»è¿›ç¨‹)                            â”‚
â”‚  æ‰«æ â†’ åˆ†ç»„ â†’ æ¨å…¥ä»»åŠ¡é˜Ÿåˆ—                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚       ä»»åŠ¡é˜Ÿåˆ—         â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚                       â”‚
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  I/O Worker 1 â”‚   â”‚  I/O Worker 2 â”‚   â”‚  I/O Worker 3 â”‚
â”‚  FFmpeg è§£ç   â”‚   â”‚  FFmpeg è§£ç   â”‚   â”‚  FFmpeg è§£ç   â”‚
â”‚  (å¤šçº¿ç¨‹)     â”‚   â”‚  (å¤šçº¿ç¨‹)     â”‚   â”‚  (å¤šçº¿ç¨‹)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚     Detection Queue   â”‚
                â”‚     (æ‰¹é‡å¸§æ•°æ®)       â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                       â”‚                       â”‚
    â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Detector 1   â”‚   â”‚  Detector 2   â”‚   â”‚  Detector 3   â”‚
â”‚  YOLO æ¨¡å‹    â”‚   â”‚  YOLO æ¨¡å‹    â”‚   â”‚  YOLO æ¨¡å‹    â”‚
â”‚  æ‰¹é‡æ¨ç†     â”‚   â”‚  æ‰¹é‡æ¨ç†     â”‚   â”‚  æ‰¹é‡æ¨ç†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŒ–ç‚¹ï¼š**
- **FFmpeg å¤šçº¿ç¨‹è§£ç **ï¼šæ¯” cv2.VideoCapture å¿« 50-100%
- **select æ»¤é•œè·³å¸§**ï¼šç›´æ¥åœ¨è§£ç é˜¶æ®µè¿‡æ»¤å¸§ï¼Œæ—  seek å¼€é”€
- **å¤š Detector Worker**ï¼šå¤šä¸ª YOLO æ¨¡å‹å®ä¾‹å¹¶è¡Œæ¨ç†
- **å¼‚æ­¥é¢„å–ï¼ˆæ·±åº¦ 8ï¼‰**ï¼šI/O Worker å¯åŒæ—¶å‘é€å¤šä¸ª batchï¼Œæ— éœ€ç­‰å¾…

#### å¤„ç†æµç¨‹

```
input-videos/
    â”‚
    â–¼ æ­¥éª¤ 1: æ‰«æä¸è§£ææ—¶é—´æˆ³
    â”‚ (ä½¿ç”¨æŒ‡å®šå“ç‰Œçš„è§£æå™¨ä»æ–‡ä»¶åæå–åˆ›å»ºæ—¶é—´)
    â”‚
    â–¼ æ­¥éª¤ 2: å»é‡
    â”‚ (æ£€æŸ¥ log.jsonlï¼Œæ¸…ç†å¤±æ•ˆè®°å½•)
    â”‚
    â–¼ æ­¥éª¤ 3: è¿ç»­æ€§åˆ†ç»„
    â”‚ (æ ¹æ®åˆ›å»ºæ—¶é—´å’Œè§†é¢‘æ—¶é•¿åˆ†ç»„)
    â”‚
    â–¼ æ­¥éª¤ 4: å¹¶è¡Œå¤„ç†
    â”‚ â”œâ”€ [ç»„A: æ–‡ä»¶1, æ–‡ä»¶2, æ–‡ä»¶3] â†’ æ£€æµ‹ â†’ åˆ‡ç‰‡ â†’ åˆå¹¶ â†’ output1.mp4
    â”‚ â””â”€ [ç»„B: æ–‡ä»¶4, æ–‡ä»¶5]        â†’ æ£€æµ‹ â†’ åˆ‡ç‰‡ â†’ åˆå¹¶ â†’ output2.mp4
    â”‚
    â–¼ æ­¥éª¤ 5: å†™å…¥æ—¥å¿—
    â”‚ (å°†ç»“æœè¿½åŠ åˆ° log.jsonlï¼Œä½¿ç”¨è¿›ç¨‹é”)
    â”‚
    â–¼
output/
â”œâ”€â”€ log.jsonl             # å¤„ç†æ—¥å¿—ï¼ˆJSONL æ ¼å¼ï¼‰
â””â”€â”€ merged/               # è¾“å‡ºè§†é¢‘
    â”œâ”€â”€ 20231115_143052_p_2.mp4        # å•è§†é¢‘è¾“å‡º
    â””â”€â”€ 20231115_143052_p_3_merged.mp4 # åˆå¹¶è§†é¢‘è¾“å‡º
```

#### å¢é‡å¤„ç†

Pipeline ä½¿ç”¨ `log.jsonl` è‡ªåŠ¨è·Ÿè¸ªå·²å¤„ç†çš„æ–‡ä»¶ï¼Œæ”¯æŒï¼š

- **è·³è¿‡å·²å¤„ç†æ–‡ä»¶**ï¼šæ—¥å¿—ä¸­å·²å­˜åœ¨çš„æ–‡ä»¶ä¼šè¢«è·³è¿‡
- **æ¢å¤ä¸­æ–­çš„å¤„ç†**ï¼šç›´æ¥é‡æ–°è¿è¡Œå‘½ä»¤å³å¯ç»§ç»­
- **è‡ªåŠ¨æ¸…ç†**ï¼šè¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨çš„å¤±æ•ˆæ—¥å¿—è®°å½•ä¼šè¢«è‡ªåŠ¨ç§»é™¤
- **é‡æ–°å¤„ç†æ–‡ä»¶**ï¼šåˆ é™¤ `log.jsonl` ä¸­å¯¹åº”çš„è®°å½•

### æ·»åŠ æ–°å“ç‰Œæ”¯æŒ

è¦æ·»åŠ æ–°çš„ç›‘æ§å“ç‰Œæ”¯æŒï¼Œåœ¨ `timestamp_parser.py` ä¸­åˆ›å»ºæ–°çš„è§£æå™¨ç±»ï¼š

```python
from timestamp_parser import BaseTimestampParser, register_parser
from pathlib import Path

class MyBrandParser(BaseTimestampParser):
    brand = "mybrand"
    description = "æˆ‘çš„å“ç‰Œ: è‡ªå®šä¹‰å‘½åè§„åˆ™"
    
    def parse(self, file_path: Path) -> float | None:
        # å®ç°è§£æé€»è¾‘
        # è¿”å› Unix æ—¶é—´æˆ³ï¼Œè§£æå¤±è´¥è¿”å› None
        filename = file_path.stem
        # ... ä»æ–‡ä»¶åè§£ææ—¶é—´æˆ³
        return timestamp

# æ³¨å†Œè§£æå™¨
register_parser("mybrand", MyBrandParser, aliases=["mb", "æˆ‘çš„å“ç‰Œ"])
```

### è¾“å‡ºæ–‡ä»¶å‘½å

- **å•è§†é¢‘å•ç‰‡æ®µ**ï¼š`{time_prefix}_p_{max_person}.mp4`
- **å¤šç‰‡æ®µæˆ–åˆå¹¶è§†é¢‘**ï¼š`{time_prefix}_p_{max_person}_merged.mp4`

å…¶ä¸­ï¼š
- `time_prefix`ï¼šä»æ–‡ä»¶åè§£æçš„åˆ›å»ºæ—¶é—´ï¼Œæ ¼å¼ä¸º `YYYYMMDD_HHMMSS`
- `max_person`ï¼šæ£€æµ‹åˆ°çš„æœ€å¤§äººæ•°

---

## Project Structure

```
surveillance-video-human-detector/
â”œâ”€â”€ pipeline.py             # Main entry point & parallel processing pipeline
â”œâ”€â”€ timestamp_parser.py     # Extensible timestamp parsers for camera brands
â”œâ”€â”€ file_time_utils.py      # File time utilities
â”œâ”€â”€ pyproject.toml          # Project dependencies
â”œâ”€â”€ yolov8n.pt              # YOLO model weights
â””â”€â”€ README.md               # This file
```

---

## License

MIT License
